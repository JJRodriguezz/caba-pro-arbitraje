<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Partido ‚Äì Asignar √Årbitro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" th:href="@{/css/partidos.css}" />
  <link rel="stylesheet" th:href="@{/css/partido-detalle.css}" />
</head>
<body>
<div class="container">
  <div class="nav-bar">
    <div class="nav-links">
      <a th:href="@{/admin/dashboard}">Dashboard</a>
      <a th:href="@{/admin/arbitros}">√Årbitros</a>
      <a th:href="@{/admin/partidos}" class="active">Partidos</a>
      <a th:href="@{/admin/torneos}">Torneos</a>
      <a th:href="@{/admin/calendario}">Calendario</a>
      <a th:href="@{/admin/notificaciones}" title="Notificaciones" class="notificaciones-btn">üîî</a>
    </div>
    <div class="user-info">
      <a th:href="@{/admin/perfil}" class="profile-link">
        <span th:text="${#authentication.name}">Administrador</span>
      </a>
      <form th:action="@{/logout}" method="post" style="display:inline;">
        <button type="submit" class="logout-btn">Salir</button>
      </form>
    </div>
  </div>


  <div th:if="${success}" class="message success" th:text="${success}"></div>
  <div th:if="${error}" class="message error" th:text="${error}"></div>


  <div class="header">
    <h1 th:text="${'Partido: ' + partido.nombre}">Partido</h1>
    <div class="action-buttons">
      <a th:href="@{/admin/partidos}" class="btn btn-secondary">Volver</a>
      <a th:href="@{'/admin/partidos/' + ${partido.id} + '/editar'}" class="btn btn-primary">Editar</a>
    </div>
  </div>

  <div class="grid-2">

    <section class="card">
      <h2 style="margin-top:0;">Informaci√≥n</h2>
      <ul class="info-list">
        <li><b>Fecha:</b> <span th:text="${#temporals.format(partido.fechaHora,'dd/MM/yyyy HH:mm')}">01/01/2026 19:00</span></li>
        <li><b>Sede:</b> <span th:text="${partido.sede}">Coliseo</span></li>
        <li><b>Equipos:</b>
          <span th:text="${partido.equipoLocal}">Local</span>
          vs
          <span th:text="${partido.equipoVisitante}">Visitante</span>
        </li>
        <li><b>Estado:</b>
          <span class="status-badge"
                th:class="'status-badge status-' + ${#strings.toLowerCase(partido.estado)}"
                th:text="${partido.estado}">PROGRAMADO</span>
        </li>
      </ul>

      <h2>Asignaciones</h2>
      <table>
        <thead>
          <tr>
            <th>√Årbitro</th>
            <th>Posici√≥n</th>
            <th>Estado</th>
            <th>Asignado</th>
          </tr>
        </thead>
        <tbody>
          <tr th:if="${#lists.isEmpty(partido.asignaciones)}">
            <td colspan="4">Sin asignaciones a√∫n.</td>
          </tr>
          <tr th:each="a : ${partido.asignaciones}">
            <td th:text="${a.arbitro.nombre + ' ' + a.arbitro.apellidos}">Nombre</td>
            <td th:text="${a.posicion}">PRINCIPAL</td>
            <td>
              <span class="status-badge"
                    th:class="'status-badge status-' + ${#strings.toLowerCase(a.estado)}"
                    th:text="${a.estado}">PENDIENTE</span>
            </td>
            <td th:text="${#temporals.format(a.asignadoEn,'dd/MM/yyyy HH:mm')}">01/01/2026 18:30</td>
          </tr>
        </tbody>
      </table>
    </section>

    <section class="card">
      <h2 id="asignar" style="margin-top:0;">Asignar √Årbitro</h2>
      
      <!-- Verificar si hay √°rbitros y posiciones disponibles -->
      <div th:if="${#lists.isEmpty(arbitros) || #lists.isEmpty(posicionesDisponibles)}">
        <div class="message error">
          <p th:if="${#lists.isEmpty(arbitros)}">
            ‚ö†Ô∏è No hay √°rbitros disponibles para asignar. Todos los √°rbitros activos ya est√°n asignados a este partido.
          </p>
          <p th:if="${#lists.isEmpty(posicionesDisponibles)}">
            ‚ö†Ô∏è No hay posiciones disponibles. Todas las posiciones ya est√°n ocupadas para este partido.
          </p>
        </div>
      </div>
      
      <form th:if="${!#lists.isEmpty(arbitros) && !#lists.isEmpty(posicionesDisponibles)}"
            th:action="@{'/admin/partidos/' + ${partido.id} + '/asignar'}"
            th:object="${asignacionDto}"
            method="post">
        <div class="form-grid">
          <div class="form-group">
            <label for="arbitroId">√Årbitro *</label>
            <select id="arbitroId" th:field="*{arbitroId}" required>
              <option value="">Selecciona un √°rbitro</option>
              <option th:each="arb : ${arbitros}"
                      th:value="${arb.id}"
                      th:text="${arb.nombre + ' ' + arb.apellidos + (disponibilidadArbitros[arb.id] ? ' ‚úì (Disponible)' : ' ‚úó (No disponible)')}"
                      th:disabled="${!disponibilidadArbitros[arb.id]}"
                      th:class="${disponibilidadArbitros[arb.id] ? 'disponible' : 'no-disponible'}">
              </option>
            </select>
            <span th:if="${#fields.hasErrors('arbitroId')}" th:errors="*{arbitroId}" class="error"></span>
            
            <!-- Mostrar informaci√≥n adicional sobre disponibilidad -->
            <div id="arbitro-info" class="arbitro-disponibilidad-info" style="margin-top: 8px; font-size: 12px; color: #666;"></div>
          </div>

          <div class="form-group">
            <label for="posicion">Posici√≥n *</label>
            <select id="posicion" th:field="*{posicion}" required>
              <option value="">Selecciona posici√≥n</option>
              <option th:each="pos : ${posicionesDisponibles}" 
                      th:value="${pos}" 
                      th:text="${pos}">PRINCIPAL</option>
            </select>
            <span th:if="${#fields.hasErrors('posicion')}" th:errors="*{posicion}" class="error"></span>
          </div>
        </div>

        <div class="buttons" style="margin-top:12px;">
          <a th:href="@{/admin/partidos}" class="btn btn-secondary">Cancelar</a>
          <button type="submit" class="btn btn-primary">Asignar</button>
        </div>
      </form>
    </section>
  </div>
</div>

<script th:inline="javascript">
document.addEventListener('DOMContentLoaded', function() {
  const arbitroSelect = document.getElementById('arbitroId');
  const arbitroInfo = document.getElementById('arbitro-info');
  
  // Verificar si los elementos existen antes de continuar

  if (!arbitroSelect || !arbitroInfo) {
    return;
  }
  
  // Mapas de disponibilidad desde el controlador
  const disponibilidadArbitros = /*[[${disponibilidadArbitros}]]*/ {};
  const motivosNoDisponible = /*[[${motivosNoDisponible}]]*/ {};
  
  arbitroSelect.addEventListener('change', function() {
    const arbitroId = this.value;
    arbitroInfo.innerHTML = '';
    
    if (arbitroId && arbitroId !== '') {
      const disponible = disponibilidadArbitros[arbitroId];
      
      if (disponible) {
        arbitroInfo.innerHTML = '<span class="info-disponible">‚úì √Årbitro disponible para este horario</span>';
      } else {
        const motivo = motivosNoDisponible[arbitroId] || 'No disponible';
        arbitroInfo.innerHTML = '<span class="info-no-disponible">‚úó ' + motivo + '</span>';
      }
    }
  });
});
</script>

</body>
</html>