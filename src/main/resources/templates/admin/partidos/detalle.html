<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>[[#{partido.titulo.prefix}]] [[${partido.nombre}]]</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" th:href="@{/css/partidos.css}" />
  <style>
    .no-disponible {
      color: #999 !important;
      background-color: #f5f5f5 !important;
    }
    
    .disponible {
      color: #28a745;
    }
    
    .arbitro-disponibilidad-info {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
    }
    
    .info-disponible {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .info-no-disponible {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- Nav -->
  <div class="nav-bar">
    <div class="nav-links">
      <a th:href="@{/admin/dashboard}" th:text="#{title.dashboard}">Dashboard</a>
      <a th:href="@{/admin/arbitros}" th:text="#{nav.arbitros}">√Årbitros</a>
      <a th:href="@{/admin/partidos}" class="active" th:text="#{nav.partidos}">Partidos</a>
      <a th:href="@{/admin/torneos}" th:text="#{nav.torneos}">Torneos</a>
      <a th:href="@{/admin/calendario}" th:text="#{nav.calendario}">Calendario</a>
      <a th:href="@{/admin/notificaciones}" th:title="#{nav.notificaciones}" class="notificaciones-btn">üîî</a>
    </div>
    <div class="user-info">
      <a th:href="@{/admin/perfil}" class="profile-link">
        <span th:text="${#authentication.name}">Administrador</span>
      </a>
      <form th:action="@{/logout}" method="post" style="display:inline;">
        <button type="submit" class="logout-btn" th:text="#{nav.salir}">Salir</button>
      </form>
    </div>
  </div>

  <!-- Mensajes -->
  <div th:if="${success}" class="message success" th:text="${success}"></div>
  <div th:if="${error}" class="message error" th:text="${error}"></div>

  <!-- Header -->
  <div class="header">
    <h1><span th:text="#{partido.titulo.prefix}">Partido:</span> <span th:text="${partido.nombre}">Partido</span></h1>
    <div class="action-buttons">
      <a th:href="@{/admin/partidos}" class="btn btn-secondary" th:text="#{partido.volver}">Volver</a>
      <a th:href="@{'/admin/partidos/' + ${partido.id} + '/editar'}" class="btn btn-primary" th:text="#{partido.editar}">Editar</a>
    </div>
  </div>

  <!-- Contenido: dos columnas -->
  <div class="grid-2">
    <!-- Columna izquierda: info + asignaciones -->
    <section class="card">
      <h2 style="margin-top:0;" th:text="#{partido.informacion}">Informaci√≥n</h2>
      <ul class="info-list">
        <li><b th:text="#{partido.fecha}">Fecha:</b> <span th:text="${#temporals.format(partido.fechaHora,'dd/MM/yyyy HH:mm')}">01/01/2026 19:00</span></li>
        <li><b th:text="#{partido.sede}">Sede:</b> <span th:text="${partido.sede}">Coliseo</span></li>
        <li><b th:text="#{partido.equipos}">Equipos:</b>
          <span th:text="${partido.equipoLocal}">Local</span>
          <span th:text="#{partido.vs}">vs</span>
          <span th:text="${partido.equipoVisitante}">Visitante</span>
        </li>
        <li><b th:text="#{partido.estado}">Estado:</b>
          <span class="status-badge"
                th:class="'status-badge status-' + ${#strings.toLowerCase(partido.estado)}"
                th:text="${partido.estado}">PROGRAMADO</span>
        </li>
      </ul>

      <h2 th:text="#{partido.asignaciones.titulo}">Asignaciones</h2>
      <table>
        <thead>
          <tr>
            <th th:text="#{partido.asignaciones.arbitro}">√Årbitro</th>
            <th th:text="#{partido.asignaciones.posicion}">Posici√≥n</th>
            <th th:text="#{partido.asignaciones.estado}">Estado</th>
            <th th:text="#{partido.asignaciones.asignado}">Asignado</th>
          </tr>
        </thead>
        <tbody>
          <tr th:if="${#lists.isEmpty(partido.asignaciones)}">
            <td colspan="4" th:text="#{partido.asignaciones.sin}">Sin asignaciones a√∫n.</td>
          </tr>
          <tr th:each="a : ${partido.asignaciones}">
            <td th:text="${a.arbitro.nombre + ' ' + a.arbitro.apellidos}">Nombre</td>
            <td th:text="${a.posicion}">PRINCIPAL</td>
            <td>
              <span class="status-badge"
                    th:class="'status-badge status-' + ${#strings.toLowerCase(a.estado)}"
                    th:text="${a.estado}">PENDIENTE</span>
            </td>
            <td th:text="${#temporals.format(a.asignadoEn,'dd/MM/yyyy HH:mm')}">01/01/2026 18:30</td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- Columna derecha: formulario de asignaci√≥n -->
    <section class="card">
      <h2 id="asignar" style="margin-top:0;" th:text="#{partido.asignar.titulo}">Asignar √Årbitro</h2>
      <form th:action="@{'/admin/partidos/' + ${partido.id} + '/asignar'}"
            th:object="${asignacionDto}"
            method="post">
        <div class="form-grid">
          <div class="form-group">
            <label for="arbitroId" th:text="#{partido.asignar.arbitro.label}">√Årbitro *</label>
            <select id="arbitroId" th:field="*{arbitroId}" required>
              <option value="" th:text="#{partido.asignar.arbitro.seleccionar}">Selecciona un √°rbitro</option>
              <option th:each="arb : ${arbitros}"
                      th:value="${arb.id}"
                      th:text="${arb.nombre + ' ' + arb.apellidos + (disponibilidadArbitros[arb.id] ? ' ‚úì (' + #{partido.asignar.disponible} + ')' : ' ‚úó (' + #{partido.asignar.no.disponible} + ')')}"
                      th:disabled="${!disponibilidadArbitros[arb.id]}"
                      th:class="${disponibilidadArbitros[arb.id] ? 'disponible' : 'no-disponible'}">
              </option>
            </select>
            <span th:if="${#fields.hasErrors('arbitroId')}" th:errors="*{arbitroId}" class="error"></span>
            
            <!-- Mostrar informaci√≥n adicional sobre disponibilidad -->
            <div id="arbitro-info" class="arbitro-disponibilidad-info" style="margin-top: 8px; font-size: 12px; color: #666;"></div>
          </div>

          <div class="form-group">
            <label for="posicion" th:text="#{partido.asignar.posicion.label}">Posici√≥n *</label>
            <select id="posicion" th:field="*{posicion}" required>
              <option value="" th:text="#{partido.asignar.posicion.seleccionar}">Selecciona posici√≥n</option>
              <option value="PRINCIPAL" th:text="#{partido.asignar.posicion.principal}">PRINCIPAL</option>
              <option value="ASISTENTE 1" th:text="#{partido.asignar.posicion.asistente1}">ASISTENTE 1</option>
              <option value="ASISTENTE 2" th:text="#{partido.asignar.posicion.asistente2}">ASISTENTE 2</option>
              <option value="ANOTADOR" th:text="#{partido.asignar.posicion.anotador}">ANOTADOR</option>
            </select>
            <span th:if="${#fields.hasErrors('posicion')}" th:errors="*{posicion}" class="error"></span>
          </div>
        </div>

        <div class="buttons" style="margin-top:12px;">
          <a th:href="@{/admin/partidos}" class="btn btn-secondary" th:text="#{btn.cancelar}">Cancelar</a>
          <button type="submit" class="btn btn-primary" th:text="#{partido.asignar.btn}">Asignar</button>
        </div>
      </form>
    </section>
  </div>
</div>

<script th:inline="javascript">
document.addEventListener('DOMContentLoaded', function() {
  const arbitroSelect = document.getElementById('arbitroId');
  const arbitroInfo = document.getElementById('arbitro-info');
  
  // Mapas de disponibilidad desde el controlador
  const disponibilidadArbitros = /*[[${disponibilidadArbitros}]]*/ {};
  const motivosNoDisponible = /*[[${motivosNoDisponible}]]*/ {};
  
  // Textos internacionalizados
  const textoDisponible = /*[[#{partido.asignar.info.disponible}]]*/ '√Årbitro disponible para este horario';
  const textoNoDisponibleDefault = /*[[#{partido.asignar.info.no.disponible.default}]]*/ 'No disponible';
  
  arbitroSelect.addEventListener('change', function() {
    const arbitroId = this.value;
    arbitroInfo.innerHTML = '';
    
    if (arbitroId && arbitroId !== '') {
      const disponible = disponibilidadArbitros[arbitroId];
      
      if (disponible) {
        arbitroInfo.innerHTML = '<span class="info-disponible">‚úì ' + textoDisponible + '</span>';
      } else {
        const motivo = motivosNoDisponible[arbitroId] || textoNoDisponibleDefault;
        arbitroInfo.innerHTML = '<span class="info-no-disponible">‚úó ' + motivo + '</span>';
      }
    }
  });
});
</script>

</body>
</html>
