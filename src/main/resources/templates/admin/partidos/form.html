<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <title>[[#{partido.crear.titulo}]] - CABA Pro</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Reutilizamos el mismo CSS para que sea visualmente id√©ntico -->
  <link rel="stylesheet" th:href="@{/css/crear-partidos.css}" />
  <!-- Google Maps JavaScript API -->
  <script th:if="${googleMapsApiKey != null and !googleMapsApiKey.isEmpty()}" 
          th:src="'https://maps.googleapis.com/maps/api/js?key=' + ${googleMapsApiKey} + '&libraries=places&callback=initMap'" 
          async defer></script>
  <style>
    #map {
      width: 100%;
      height: 400px;
      border-radius: 8px;
      margin-top: 10px;
      border: 2px solid #ddd;
    }
    .map-container {
      margin-bottom: 20px;
    }
    .map-info {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      font-size: 0.9em;
      color: #6c757d;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- Navigation -->
  <div class="nav-bar">
    <a th:href="@{/admin/dashboard}" th:text="#{nav.dashboard}">Dashboard</a>
    <a th:href="@{/admin/partidos}" th:text="#{nav.partidos}">Partidos</a>
    <a href="#" style="background: rgba(255,255,255,0.3);" th:text="#{partido.crear.titulo}">Crear Partido</a>
  </div>

  <h1 th:text="#{partido.crear.titulo.nuevo}">Crear Nuevo Partido</h1>

  <!-- Messages -->
  <div th:if="${success}" class="message success" th:text="${success}"></div>
  <div th:if="${error}" class="message error" th:text="${error}"></div>

  <!-- Form -->
  <form th:action="@{/admin/partidos}" method="post" th:object="${partidoDto}">
    <p style="margin-top:-10px;color:#6c757d;" th:text="#{partido.crear.campos.obligatorios}">Los campos marcados con * son obligatorios.</p>

    <div class="form-grid">
      <div class="form-group">
        <label for="nombre" th:text="#{partido.editar.nombre}">Nombre *</label>
        <input type="text" id="nombre" th:field="*{nombre}" required>
        <span th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}" class="error"></span>
      </div>

      <div class="form-group">
        <label for="descripcion" th:text="#{partido.editar.descripcion}">Descripci√≥n</label>
        <input type="text" id="descripcion" th:field="*{descripcion}" th:placeholder="#{partido.crear.descripcion.placeholder}">
        <span th:if="${#fields.hasErrors('descripcion')}" th:errors="*{descripcion}" class="error"></span>
      </div>

      <div class="form-group">
        <label for="fechaHora" th:text="#{partido.editar.fecha.hora}">Fecha y hora *</label>
        <input type="datetime-local" id="fechaHora" th:field="*{fechaHora}" required>
        <span th:if="${#fields.hasErrors('fechaHora')}" th:errors="*{fechaHora}" class="error"></span>
      </div>

      <div class="form-group">
        <label for="sede" th:text="#{partido.editar.sede.label}">Sede *</label>
        <input type="text" id="sede" th:field="*{sede}" required>
        <span th:if="${#fields.hasErrors('sede')}" th:errors="*{sede}" class="error"></span>
      </div>
    </div>

    <!-- Google Maps Section (Opcional) -->
    <div class="map-container" th:if="${googleMapsApiKey != null and !googleMapsApiKey.isEmpty()}">
      <h3 style="margin-bottom: 10px;" th:text="'üìç ' + #{partido.ubicacion.titulo}">üìç Ubicaci√≥n del Partido (Opcional)</h3>
      <p style="color: #6c757d; margin-bottom: 10px;" th:text="#{partido.ubicacion.descripcion}">
        Busca y selecciona la ubicaci√≥n exacta del partido en el mapa. Esto ayudar√° a los √°rbitros a encontrar el lugar.
      </p>
      
      <!-- Campo de b√∫squeda -->
      <input type="text" 
             id="autocomplete" 
             th:placeholder="'üîç ' + #{partido.ubicacion.buscar.placeholder}"
             placeholder="üîç Buscar ubicaci√≥n en el mapa..."
             style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 5px; margin-bottom: 10px; font-size: 1em;">
      
      <!-- Mapa -->
      <div id="map"></div>
      
      <!-- Campos ocultos para guardar coordenadas -->
      <input type="hidden" id="ubicacion" th:field="*{ubicacion}">
      <input type="hidden" id="latitud" th:field="*{latitud}">
      <input type="hidden" id="longitud" th:field="*{longitud}">
      
      <!-- Info de ubicaci√≥n seleccionada -->
      <div class="map-info" id="map-info" style="display: none;">
        <strong>‚úì <span th:text="#{partido.ubicacion.seleccionada}">Ubicaci√≥n seleccionada:</span></strong> <span id="selected-location"></span><br>
        <small><span th:text="#{partido.ubicacion.latitud} + ': ' + #{partido.ubicacion.longitud}">Coordenadas:</span> <span id="selected-coords"></span></small>
      </div>
    </div>

    <div class="form-grid">
      <div class="form-group">
        <label for="torneoId" th:text="#{partido.editar.torneo}">Torneo (Opcional)</label>
        <select id="torneoId" th:field="*{torneoId}">
          <option value="" th:text="#{partido.editar.torneo.ninguno}">No asociar a ning√∫n torneo</option>
          <option th:each="torneo : ${torneos}" 
                  th:value="${torneo.id}" 
                  th:text="${torneo.nombre + ' (' + torneo.estado.descripcion + ')'}">
            Torneo ejemplo
          </option>
        </select>
        <small style="color: #6c757d; font-size: 0.875rem;" th:text="#{partido.crear.torneo.ayuda}">
          Selecciona un torneo si este partido forma parte de una competencia oficial.
        </small>
        <span th:if="${#fields.hasErrors('torneoId')}" th:errors="*{torneoId}" class="error"></span>
      </div>

      <div class="form-group">
        <label for="equipoLocal" th:text="#{partido.editar.equipo.local}">Equipo local *</label>
        <input type="text" id="equipoLocal" th:field="*{equipoLocal}" required>
        <span th:if="${#fields.hasErrors('equipoLocal')}" th:errors="*{equipoLocal}" class="error"></span>
      </div>

      <div class="form-group">
        <label for="equipoVisitante" th:text="#{partido.editar.equipo.visitante}">Equipo visitante *</label>
        <input type="text" id="equipoVisitante" th:field="*{equipoVisitante}" required>
        <span th:if="${#fields.hasErrors('equipoVisitante')}" th:errors="*{equipoVisitante}" class="error"></span>
      </div>
    </div>

    <!-- Buttons -->
    <div class="buttons">
      <a th:href="@{/admin/partidos}" class="btn btn-secondary" th:text="#{btn.cancelar}">Cancelar</a>
      <button type="submit" class="btn btn-primary" th:text="#{partido.crear.btn}">Crear Partido</button>
    </div>
  </form>
</div>

<script th:inline="javascript">
/*<![CDATA[*/
// Variables de traducci√≥n
const i18n = {
  customLocation: /*[[#{partido.ubicacion.personalizada}]]*/ 'Custom location'
};

let map;
let marker;
let autocomplete;

// Inicializar el mapa
function initMap() {
  // Coordenadas por defecto (Buenos Aires, Argentina)
  const defaultLocation = { lat: -34.6037, lng: -58.3816 };
  
  // Crear el mapa
  map = new google.maps.Map(document.getElementById('map'), {
    center: defaultLocation,
    zoom: 12,
    mapTypeControl: true,
    streetViewControl: false,
    fullscreenControl: true
  });
  
  // Crear marcador
  marker = new google.maps.Marker({
    map: map,
    draggable: true,
    animation: google.maps.Animation.DROP
  });
  
  // Configurar autocomplete para b√∫squeda
  const input = document.getElementById('autocomplete');
  autocomplete = new google.maps.places.Autocomplete(input);
  autocomplete.bindTo('bounds', map);
  
  // Cuando se selecciona un lugar del autocomplete
  autocomplete.addListener('place_changed', function() {
    const place = autocomplete.getPlace();
    
    if (!place.geometry) {
      return;
    }
    
    // Centrar mapa y colocar marcador
    if (place.geometry.viewport) {
      map.fitBounds(place.geometry.viewport);
    } else {
      map.setCenter(place.geometry.location);
      map.setZoom(17);
    }
    
    marker.setPosition(place.geometry.location);
    marker.setVisible(true);
    
    // Guardar informaci√≥n
    updateLocationInfo(place.geometry.location, place.formatted_address || place.name);
  });
  
  // Click en el mapa para colocar marcador
  map.addListener('click', function(event) {
    marker.setPosition(event.latLng);
    marker.setVisible(true);
    
    // Geocoding inverso para obtener la direcci√≥n
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ location: event.latLng }, function(results, status) {
      if (status === 'OK' && results[0]) {
        updateLocationInfo(event.latLng, results[0].formatted_address);
      } else {
        updateLocationInfo(event.latLng, i18n.customLocation);
      }
    });
  });
  
  // Arrastrar marcador
  marker.addListener('dragend', function(event) {
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ location: event.latLng }, function(results, status) {
      if (status === 'OK' && results[0]) {
        updateLocationInfo(event.latLng, results[0].formatted_address);
      } else {
        updateLocationInfo(event.latLng, i18n.customLocation);
      }
    });
  });
}

// Actualizar informaci√≥n de ubicaci√≥n
function updateLocationInfo(location, address) {
  // Actualizar campos ocultos
  document.getElementById('ubicacion').value = address;
  document.getElementById('latitud').value = location.lat();
  document.getElementById('longitud').value = location.lng();
  
  // Mostrar informaci√≥n
  document.getElementById('selected-location').textContent = address;
  document.getElementById('selected-coords').textContent = 
    `${location.lat().toFixed(6)}, ${location.lng().toFixed(6)}`;
  document.getElementById('map-info').style.display = 'block';
}

// Si hay errores de validaci√≥n y ya hay coordenadas, restaurar el mapa
window.addEventListener('load', function() {
  const latitudInput = document.getElementById('latitud');
  const longitudInput = document.getElementById('longitud');
  const ubicacionInput = document.getElementById('ubicacion');
  
  if (latitudInput && longitudInput && latitudInput.value && longitudInput.value) {
    setTimeout(function() {
      const lat = parseFloat(latitudInput.value);
      const lng = parseFloat(longitudInput.value);
      const location = new google.maps.LatLng(lat, lng);
      
      map.setCenter(location);
      map.setZoom(15);
      marker.setPosition(location);
      marker.setVisible(true);
      
      updateLocationInfo(location, ubicacionInput.value || 'Ubicaci√≥n guardada');
    }, 500);
  }
});
/*]]>*/
</script>
</body>
</html>
