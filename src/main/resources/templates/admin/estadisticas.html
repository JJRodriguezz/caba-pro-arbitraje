<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>[[#{estadisticas.titulo}]] - CABA Pro</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" th:href="@{/css/admin-dashboard.css}" />
  <link rel="stylesheet" th:href="@{/css/estadisticas.css}" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <nav class="header-nav">
    <div class="nav-links">
      <a th:href="@{/admin/arbitros}" th:text="#{nav.arbitros}">√Årbitros</a>
      <a th:href="@{/admin/partidos}" th:text="#{nav.partidos}">Partidos</a>
      <a th:href="@{/admin/torneos}" th:text="#{nav.torneos}">Torneos</a>
      <a th:href="@{/admin/calendario}" th:text="#{nav.calendario}">Calendario</a>
      <a th:href="@{/admin/notificaciones}" th:title="#{nav.notificaciones}" class="notificaciones-btn">üîî</a>
    </div>
    <div class="user-section">
      <a th:href="@{/admin/perfil}" class="profile-link">
        <span sec:authentication="name">Administrador</span>
      </a>
      <form th:action="@{/logout}" method="post" style="display: inline;">
        <button type="submit" class="logout-btn">üîì <span th:text="#{nav.salir}">Salir</span></button>
      </form>
    </div>
  </nav>
  <div class="estadisticas-container">
    <h1 class="estadisticas-titulo" th:text="#{estadisticas.titulo}">Estad√≠sticas de √Årbitros</h1>
    <form method="get" th:action="@{/admin/estadisticas}" class="filter-form estadisticas-filtros">
      <label for="desde" th:text="#{estadisticas.desde}">Desde:</label>
      <input type="date" id="desde" name="desde" th:value="${desde}" />
      <label for="hasta" th:text="#{estadisticas.hasta}">Hasta:</label>
      <input type="date" id="hasta" name="hasta" th:value="${hasta}" />
      <button type="submit" th:text="#{estadisticas.filtrar}">Filtrar</button>
    </form>

    <section class="estadisticas-section">
      <h2 th:text="#{estadisticas.arbitros.activos}">√Årbitros activos</h2>
      <p><span th:text="#{estadisticas.total}">Total:</span> <span th:text="${arbitrosStats.totalActivos}"></span></p>
      <h3 th:text="#{estadisticas.por.especialidad}">Por especialidad</h3>
      <ul>
        <li th:each="entry : ${arbitrosStats.cantidadPorEspecialidad}">
          <span th:text="${entry.key}"></span>: <span th:text="${entry.value}"></span>
        </li>
      </ul>
      <div th:if="${arbitrosStats.cantidadPorEspecialidad == null or #lists.isEmpty(arbitrosStats.cantidadPorEspecialidad)}" class="no-data-message">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><text x="12" y="16" text-anchor="middle" font-size="12" fill="#fff">i</text></svg>
        <span th:text="#{estadisticas.sin.datos.especialidad}">No hay datos de especialidades disponibles.</span>
      </div>
      <h3 th:text="#{estadisticas.por.escalafon}">Por escalaf√≥n</h3>
      <ul>
        <li th:each="entry : ${arbitrosStats.cantidadPorEscalafon}">
          <span th:text="${entry.key}"></span>: <span th:text="${entry.value}"></span>
        </li>
      </ul>
      <div th:if="${arbitrosStats.cantidadPorEscalafon == null or #lists.isEmpty(arbitrosStats.cantidadPorEscalafon)}" class="no-data-message">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><text x="12" y="16" text-anchor="middle" font-size="12" fill="#fff">i</text></svg>
        <span th:text="#{estadisticas.sin.datos.escalafon}">No hay datos de escalaf√≥n disponibles.</span>
      </div>
    </section>

    <section class="estadisticas-section">
      <h2 th:text="#{estadisticas.asignaciones}">Asignaciones</h2>
  <p><span th:text="#{estadisticas.total}">Total:</span> <span th:text="${asignacionesStats.totalAsignaciones}"></span></p>
  <p><span th:text="#{estadisticas.aceptadas}">Aceptadas:</span> <span th:text="${asignacionesStats.aceptadas}"></span> (<span th:text="${#numbers.formatDecimal(asignacionesStats.porcentajeAceptadas, 1, 1)}"></span>%)</p>
  <p><span th:text="#{estadisticas.rechazadas}">Rechazadas:</span> <span th:text="${asignacionesStats.rechazadas}"></span> (<span th:text="${#numbers.formatDecimal(asignacionesStats.porcentajeRechazadas, 1, 1)}"></span>%)</p>
      <div th:if="${asignacionesStats.totalAsignaciones == null or asignacionesStats.totalAsignaciones == 0}" class="no-data-message">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><text x="12" y="16" text-anchor="middle" font-size="12" fill="#fff">i</text></svg>
        <span th:text="#{estadisticas.sin.datos.asignaciones}">No hay datos de asignaciones disponibles.</span>
      </div>
    </section>

    <section class="estadisticas-section">
      <h2 th:text="#{estadisticas.top5}">Top 5 √Årbitros m√°s activos</h2>
      <div style="display: flex; justify-content: center;">
        <table class="estadisticas-table top-table" th:if="${topArbitros.topArbitros != null and !#lists.isEmpty(topArbitros.topArbitros)}">
        <thead>
          <tr class="text-center">
            <th th:text="#{estadisticas.top5.nombre}">Nombre</th>
            <th th:text="#{estadisticas.top5.asignaciones}">Asignaciones Aceptadas</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="arbitro : ${topArbitros.topArbitros}" class="text-center">
            <td th:text="${arbitro.nombreCompleto}"></td>
            <td th:text="${arbitro.cantidadAsignaciones}"></td>
          </tr>
        </tbody>
      </table>
      <div th:if="${topArbitros.topArbitros == null or #lists.isEmpty(topArbitros.topArbitros)}" class="no-data-message">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><text x="12" y="16" text-anchor="middle" font-size="12" fill="#fff">i</text></svg>
        <span th:text="#{estadisticas.sin.datos.top}">No hay datos de √°rbitros activos disponibles.</span>
      </div>
    </section>

    <section class="estadisticas-section">
      <h2 th:text="#{estadisticas.graficos}">Gr√°ficos</h2>
      <div class="estadisticas-graficos">
        <div>
          <canvas id="graficoEspecialidad" width="400" height="200"></canvas>
          <div th:if="${arbitrosStats.cantidadPorEspecialidad == null or #lists.isEmpty(arbitrosStats.cantidadPorEspecialidad)}" class="no-data-message">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><text x="12" y="16" text-anchor="middle" font-size="12" fill="#fff">i</text></svg>
            <span th:text="#{estadisticas.sin.datos.grafico.especialidad}">No hay datos para graficar especialidades.</span>
          </div>
        </div>
        <div>
          <canvas id="graficoAsignaciones" width="400" height="200"></canvas>
          <div th:if="${asignacionesStats.totalAsignaciones == null or asignacionesStats.totalAsignaciones == 0}" class="no-data-message">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><text x="12" y="16" text-anchor="middle" font-size="12" fill="#fff">i</text></svg>
            <span th:text="#{estadisticas.sin.datos.grafico.asignaciones}">No hay datos para graficar asignaciones.</span>
          </div>
        </div>
      </div>
      <script th:inline="javascript">
        /*<![CDATA[*/
        // 1) Inyecta los datos crudos tal cual (Thymeleaf los serializa como objeto JS en modo inline)
        const mapaEspecialidad = /*[[${arbitrosStats.cantidadPorEspecialidad}]]*/ null;
        const totalAsignaciones = /*[[${asignacionesStats != null ? asignacionesStats.totalAsignaciones : 0}]]*/ 0;
        const aceptadas = /*[[${asignacionesStats != null ? asignacionesStats.aceptadas : 0}]]*/ 0;
        const rechazadas = /*[[${asignacionesStats != null ? asignacionesStats.rechazadas : 0}]]*/ 0;
        const labelEspecialidad = /*[[#{estadisticas.grafico.especialidad.label}]]*/ '√Årbitros por especialidad';
        const labelAsignaciones = /*[[#{estadisticas.grafico.asignaciones.label}]]*/ 'Asignaciones';
        const labelAceptadas = /*[[#{estadisticas.aceptadas}]]*/ 'Aceptadas';
        const labelRechazadas = /*[[#{estadisticas.rechazadas}]]*/ 'Rechazadas';

        // 2) Transforma a arrays seguros en el navegador (evita #maps/#lists/#arrays)
        const especialidades = mapaEspecialidad ? Object.keys(mapaEspecialidad) : [];
        const cantidades     = mapaEspecialidad ? Object.values(mapaEspecialidad) : [];
        const datosAsignaciones = [Number(aceptadas)||0, Number(rechazadas)||0];
        const etiquetasAsignaciones = [labelAceptadas, labelRechazadas];

        // Diagn√≥stico en consola (mira DevTools ‚Üí Console)
        console.log('[Estad√≠sticas] especialidades:', especialidades);
        console.log('[Estad√≠sticas] cantidades:', cantidades);
        console.log('[Estad√≠sticas] asignaciones:', datosAsignaciones, 'total:', totalAsignaciones);

        // 3) Dibuja solo si hay datos y el canvas existe
        (function initCharts(){
            const ce = document.getElementById('graficoEspecialidad');
            if (ce && especialidades.length && cantidades.length) {
            new Chart(ce.getContext('2d'), {
                type: 'bar',
                data: {
                labels: especialidades,
                datasets: [{ label: labelEspecialidad, data: cantidades }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
            }

            const ca = document.getElementById('graficoAsignaciones');
            if (ca && (datosAsignaciones[0] > 0 || datosAsignaciones[1] > 0)) {
            new Chart(ca.getContext('2d'), {
                type: 'pie',
                data: {
                labels: etiquetasAsignaciones,
                datasets: [{ label: labelAsignaciones, data: datosAsignaciones }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
            }
        })();
        /*]]>*/
        </script>
    </section>
  </div>
</body>
</html>
